import time
import pyqtgraph
import status_ui
from datetime import datetime
from PyQt5 import QtWidgets, QtGui, QtCore

class TimeAxis(pyqtgraph.AxisItem):
	def tickStrings(self, values, *args):
		return [datetime.fromtimestamp(value).strftime('%H:%M:%S') for value in values]

class StatusWindow(QtWidgets.QMainWindow):

	def __init__(self):
		super().__init__()
		status_ui.Ui_MainWindow().setupUi(self)
		self.setFixedSize(self.size())

		# ColorMap
		colors = [(0, 255, 0), (255, 255, 0), (255, 0, 0)]
		nb_colors = len(colors)
		pos = [i / (nb_colors - 1) for i in range(nb_colors)]
		self.colormap = pyqtgraph.ColorMap(pos, colors)

		# Graph
		self.plot = pyqtgraph.PlotWidget(background='#111111', axisItems={'bottom': TimeAxis(orientation='bottom')})
		self.findChild(QtWidgets.QVBoxLayout, 'GraphLayout').addWidget(self.plot)
		self.plot.hideAxis('left')
		self.plot.setMouseEnabled(y=False)
		self.y_delta = 0.3
		y_range = 1 + self.y_delta
		self.plot_x_minrange = 100
		self.plot_x_maxrange = 1000
		self.plot.setLimits(
			yMin = 0,
			yMax = 1 + self.y_delta,
			xMin = 0,
			xMax = self.plot_x_minrange,
			minYRange = y_range,
			maxYRange = y_range,
			minXRange = self.plot_x_minrange,
			maxXRange = self.plot_x_maxrange,
		)
		self.plot_x = []
		self.plot_y = []
		self.plot_text_items = []

		# Refresh
		self.timer = QtCore.QTimer()
		self.timer.timeout.connect(self._refreshPlot)
		self.timer.start(1000)

		# TODO remove
		now = time.time()
		for i, value in enumerate([0.79, 0.77, 0.76, 0.76, 0.76, 0.77, 0.79, 0.81, 0.83, 0.84, 0.84, 0.83, 0.82, 0.81, 0.79, 0.78, 0.77, 0.77, 0.76, 0.76, 0.77, 0.77, 0.77, 0.77, 0.77, 0.77, 0.76, 0.75, 0.74, 0.72, 0.71, 0.71, 0.71, 0.73, 0.75, 0.76, 0.77, 0.77, 0.76, 0.74, 0.72, 0.7, 0.69, 0.69, 0.69, 0.71, 0.71, 0.7, 0.68, 0.66, 0.65, 0.64, 0.63, 0.64, 0.65, 0.65, 0.66, 0.66, 0.65, 0.65, 0.64, 0.64, 0.64, 0.66, 0.67, 0.67, 0.66, 0.64, 0.6, 0.57, 0.54, 0.53, 0.54, 0.56, 0.58, 0.6, 0.63, 0.65, 0.67, 0.68, 0.68, 0.67, 0.65, 0.63, 0.61, 0.59, 0.58, 0.56, 0.55, 0.55, 0.57, 0.6, 0.63, 0.67, 0.72, 0.76, 0.79, 0.81, 0.82, 0.81, 0.78, 0.76, 0.73, 0.71, 0.68, 0.66, 0.65, 0.65, 0.65, 0.65, 0.66, 0.66, 0.65, 0.64, 0.63, 0.61, 0.61, 0.6, 0.6, 0.59, 0.59, 0.58, 0.56, 0.55, 0.55, 0.56, 0.58, 0.6, 0.62, 0.63, 0.64, 0.64, 0.64, 0.64, 0.63, 0.63, 0.63, 0.64, 0.65, 0.66, 0.66, 0.67, 0.68, 0.69, 0.69, 0.69, 0.69, 0.68, 0.67, 0.65, 0.64, 0.64, 0.64, 0.66, 0.69, 0.73, 0.78, 0.84, 0.88, 0.92, 0.96, 0.98, 1.0, 1.0, 0.99, 0.98, 0.96, 0.93, 0.91, 0.87, 0.85, 0.84, 0.82, 0.81, 0.79, 0.77, 0.76, 0.74, 0.71, 0.69, 0.68, 0.67, 0.65, 0.63, 0.61, 0.58, 0.57, 0.56, 0.55, 0.54, 0.52, 0.52, 0.51, 0.51, 0.51, 0.5, 0.48, 0.45, 0.43, 0.42, 0.42, 0.42, 0.43, 0.45, 0.47, 0.49, 0.51, 0.52, 0.52, 0.51, 0.48, 0.45, 0.41, 0.38, 0.35, 0.34, 0.35, 0.36, 0.38, 0.41, 0.45, 0.48, 0.53, 0.58, 0.61, 0.62, 0.62, 0.59, 0.55, 0.5, 0.43, 0.36, 0.31, 0.27, 0.25, 0.22, 0.2, 0.19, 0.2, 0.22, 0.26, 0.31, 0.36, 0.38, 0.38, 0.38, 0.38, 0.38, 0.4, 0.43, 0.46, 0.51, 0.55, 0.6, 0.63, 0.66, 0.68, 0.67, 0.65, 0.63, 0.6, 0.57, 0.54, 0.52, 0.51, 0.51, 0.54, 0.57, 0.61, 0.63, 0.64, 0.64, 0.62, 0.61, 0.61, 0.6, 0.58, 0.57, 0.56, 0.54, 0.54, 0.55, 0.57, 0.6, 0.65, 0.7, 0.74, 0.77, 0.79, 0.81, 0.81, 0.79, 0.77, 0.73, 0.69, 0.64, 0.59, 0.54, 0.51, 0.5, 0.5, 0.52, 0.54, 0.57, 0.6, 0.63, 0.67, 0.69, 0.69, 0.68, 0.67, 0.64, 0.61, 0.57, 0.52, 0.49, 0.46, 0.46, 0.46, 0.47, 0.48, 0.48, 0.49, 0.49, 0.5, 0.51, 0.51, 0.52, 0.52, 0.51, 0.49, 0.47, 0.45, 0.44, 0.44, 0.45, 0.46, 0.49, 0.51, 0.52, 0.54, 0.55, 0.55, 0.55, 0.54, 0.53, 0.51, 0.49, 0.47, 0.44, 0.41, 0.38, 0.35, 0.34, 0.35, 0.36, 0.38, 0.4, 0.42, 0.42, 0.41, 0.39, 0.36, 0.34, 0.31, 0.29, 0.27, 0.25, 0.22, 0.21, 0.2, 0.2, 0.22, 0.24, 0.27, 0.29, 0.32, 0.34, 0.37, 0.38, 0.37, 0.35, 0.32, 0.28, 0.22, 0.17, 0.13, 0.09, 0.07, 0.05, 0.02, 0.0, 0.0, 0.01, 0.04, 0.07, 0.11, 0.15, 0.18, 0.2, 0.22, 0.22, 0.21, 0.2, 0.18, 0.16, 0.16, 0.17, 0.21, 0.25, 0.3, 0.34, 0.38, 0.4, 0.4, 0.39, 0.36, 0.33, 0.29, 0.27, 0.25, 0.25, 0.25, 0.27, 0.3, 0.33, 0.38, 0.41, 0.45, 0.48, 0.5, 0.5, 0.49, 0.47, 0.43, 0.4, 0.37, 0.34, 0.31, 0.28, 0.26, 0.25, 0.26, 0.28, 0.31, 0.35, 0.39, 0.45, 0.5, 0.54, 0.56, 0.57, 0.55, 0.53, 0.49, 0.45, 0.4, 0.35, 0.32, 0.29, 0.28, 0.29, 0.31, 0.35, 0.39, 0.43, 0.48, 0.51, 0.53, 0.54, 0.54, 0.52, 0.48, 0.43, 0.38, 0.32, 0.27, 0.23, 0.21, 0.22, 0.23, 0.26, 0.3, 0.35, 0.39, 0.42, 0.44, 0.44, 0.42, 0.38, 0.33, 0.28, 0.23, 0.19, 0.16, 0.14, 0.14, 0.15, 0.16, 0.18, 0.21, 0.24, 0.28, 0.31, 0.33, 0.34, 0.35, 0.35, 0.34, 0.33, 0.31, 0.29, 0.28, 0.27, 0.28, 0.29, 0.31, 0.33, 0.35, 0.38, 0.4, 0.41, 0.42, 0.42, 0.42, 0.4, 0.39, 0.38, 0.38, 0.38, 0.39, 0.39, 0.4, 0.42, 0.44, 0.46, 0.48, 0.5, 0.52, 0.55, 0.56, 0.57, 0.57, 0.55, 0.53, 0.5, 0.48, 0.46, 0.44, 0.44, 0.45, 0.46, 0.48, 0.5, 0.51, 0.52, 0.53, 0.54, 0.55, 0.55, 0.54, 0.51, 0.48, 0.44, 0.4, 0.37, 0.35, 0.35, 0.34, 0.36, 0.38, 0.39, 0.41, 0.43, 0.44, 0.44, 0.43, 0.42, 0.39, 0.35, 0.3, 0.26, 0.22, 0.18, 0.15, 0.14, 0.15, 0.17, 0.19, 0.22, 0.25, 0.28, 0.3, 0.31, 0.32, 0.3, 0.28, 0.25, 0.21, 0.17, 0.15, 0.13, 0.13, 0.15, 0.17, 0.21, 0.26, 0.31, 0.36, 0.4, 0.43, 0.46, 0.47, 0.48, 0.47, 0.45, 0.42, 0.38, 0.34, 0.32, 0.31, 0.31, 0.33, 0.35, 0.37, 0.4, 0.43, 0.45, 0.48, 0.49, 0.5, 0.49, 0.47, 0.44, 0.39, 0.34, 0.29, 0.24, 0.18, 0.14, 0.11, 0.1, 0.1, 0.11, 0.14, 0.17, 0.21, 0.26, 0.3, 0.33, 0.34, 0.34, 0.33, 0.3, 0.26, 0.2, 0.14, 0.09, 0.06, 0.05, 0.06, 0.08, 0.12, 0.16, 0.21, 0.26, 0.31, 0.34, 0.36, 0.37, 0.36, 0.34, 0.3, 0.27, 0.25, 0.24, 0.24, 0.25, 0.26, 0.27, 0.28, 0.29, 0.31, 0.33, 0.35, 0.38, 0.4, 0.41, 0.42, 0.43, 0.44, 0.45, 0.46, 0.46, 0.46, 0.45, 0.45, 0.44, 0.43, 0.42, 0.41, 0.41, 0.41, 0.41, 0.39, 0.38, 0.36, 0.35, 0.35, 0.37, 0.39, 0.42, 0.45, 0.48, 0.51, 0.53, 0.54, 0.53, 0.53, 0.52, 0.52, 0.53, 0.53, 0.55, 0.57, 0.59, 0.61, 0.63, 0.65, 0.67, 0.68, 0.69, 0.68, 0.67, 0.67, 0.66, 0.65, 0.63, 0.61, 0.59, 0.56, 0.55, 0.54, 0.54, 0.56, 0.57, 0.58, 0.59, 0.6, 0.6, 0.59, 0.57, 0.54, 0.51, 0.47, 0.44, 0.41, 0.38, 0.37, 0.36, 0.36, 0.38, 0.4, 0.41, 0.43, 0.44, 0.45, 0.45, 0.44, 0.42, 0.39, 0.37, 0.34, 0.32, 0.31, 0.31, 0.31, 0.33, 0.36, 0.39, 0.42, 0.46, 0.5, 0.52, 0.52, 0.51, 0.48, 0.45, 0.41, 0.37, 0.34, 0.33, 0.34, 0.35, 0.38, 0.4, 0.44, 0.47, 0.5, 0.51, 0.51, 0.52, 0.52, 0.51, 0.51, 0.51, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.51, 0.52, 0.53, 0.54, 0.55, 0.55, 0.57, 0.58, 0.59, 0.59, 0.59, 0.6, 0.61, 0.64, 0.69, 0.75, 0.81, 0.84, 0.86, 0.86, 0.85, 0.84, 0.82, 0.82, 0.81, 0.8, 0.79, 0.78, 0.76, 0.74, 0.72, 0.71, 0.7, 0.69, 0.68, 0.66, 0.66, 0.68, 0.69, 0.69, 0.69, 0.67, 0.65, 0.63, 0.61, 0.61, 0.6, 0.58, 0.56, 0.54, 0.53, 0.52, 0.54, 0.55, 0.58, 0.6, 0.62, 0.64, 0.67, 0.69, 0.72, 0.73, 0.74, 0.74, 0.73, 0.72, 0.72, 0.72, 0.72, 0.72, 0.72, 0.73, 0.74, 0.76, 0.77, 0.77, 0.77, 0.78, 0.78, 0.79, 0.81, 0.82, 0.83, 0.83]):
			self.plotXY(now + i, value)
		self.plotText(now, 'Claustrophobia')
		self.plotText(now + 150, 'Arachnophobia')
		self.plotText(now + 325, 'Vertigo')
		self.plotText(now + 700, 'Arachnophobia')

	def plotText(self, x, text):
		item = pyqtgraph.TextItem(html=f'<div style="text-align: center;color: #FFFFFF;font-size: 16pt;">{text}</div>', anchor=(0, 0), border='w')
		item.setPos(x, 1 + self.y_delta)
		self.plot_text_items.append(item)
		self.plot_text_items.append(pyqtgraph.InfiniteLine(pos=(x, 0), angle=90))

	def plotXY(self, x, y):
		assert not self.plot_x or self.plot_x[-1] <= x
		self.plot_x.append(x)
		self.plot_y.append(y)

	def _refreshPlot(self):

		# Biofeedbacks
		xmin = self.plot_x[0]
		xmax = self.plot_x[-1]
		miss = xmin + self.plot_x_minrange - xmax
		if miss > 0:
			xmax += miss
		self.plot.setLimits(xMin=xmin, xMax=xmax)
		self.plot.clear()
		brushes = [pyqtgraph.mkBrush(c) for c in self.colormap.map(self.plot_y)]
		self.plot.plot(self.plot_x, self.plot_y, symbolBrush=brushes)

		# Rooms
		for item in self.plot_text_items:
			self.plot.addItem(item)

def create_app(*args, **kwargs):
	app = QtWidgets.QApplication(*args, **kwargs)
	QtGui.QFontDatabase.addApplicationFont(':font/gorestep.ttf')
	return app.exec_